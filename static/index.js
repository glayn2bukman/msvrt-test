"use strict";var SERVER={protocol:"http://",port:9988},SERVERS=["45.33.6.237","104.237.142.183","45.33.74.38","139.162.235.29"],URIs={login:"login",upload:"upload"},DEVICE_SERIAL_NUMBER="",LOCATION=null,AGENT={uname:"",names:""},BTPrinterName="Qsprinter";function _done_request(){stop_loading(),200===this.status?this.onsucess&&this.onsucess(this.responseText,this.glue):this.onfailure&&this.onfailure("reply code: "+this.status)}function _request_failed(){if(console.log("server "+this.server+"...failed"),this.server++,this.server>=SERVERS.length)return showToast("failed to communicate with server. are you online?"),void stop_loading();request(this.uri,this.method,this.payload,this.onsucess,this.onfailure,this.server,this.glue,this._onprogress)}function request(e,t,n=null,o=null,s=null,i=0,r=null,a=null){var l=new XMLHttpRequest;l.open(t,SERVER.protocol+SERVERS[i]+":"+SERVER.port+"/"+e,!0),l.onsucess=o,l.onfailure=s,l._onprogress=a,l.glue=r,l.server=i,l.method=t,l.uri=e,l.payload=n,l.onload=_done_request,l.onerror=_request_failed,a&&(l.onprogress=a),l.send(n),start_loading()}function readserial(){try{DEVICE_SERIAL_NUMBER=device.serial}catch(e){}}function readbarcode(){try{cordova.plugins.barcodeScanner.scan(function(e){document.getElementById("sn").value=e.text},function(e){},{preferFrontCamera:!1,showFlipCameraButton:!0,showTorchButton:!0,torchOn:!1,prompt:"scan barcode"})}catch(e){flag_error(e+". this is likely because you're on PC")}}function increase_opacity(e,t){(t+=.1)>=1||(e.style.opacity=t+"",setTimeout(increase_opacity,150,e,t))}function back(e){"personnel"==e?(document.getElementById("personnel").style.display="none",document.getElementById("inspection").style.display="block",increase_opacity(document.getElementById("inspection"),0)):"inspection"==e?(document.getElementById("inspection").style.display="none",document.getElementById("meter_details").style.display="block",increase_opacity(document.getElementById("meter_details"),0)):"meter_details"==e&&logout()}function next(e){if("personnel"==e);else if("inspection"==e)document.getElementById("inspection").style.display="none",document.getElementById("personnel").style.display="block",increase_opacity(document.getElementById("personnel"),0);else if("meter_details"==e){let e=validate_form("meter_details");if("debug"!=DEVICE_SERIAL_NUMBER&&!e.status)return void flag_error(e.log+" is blank!");document.getElementById("meter_details").style.display="none",document.getElementById("inspection").style.display="block",increase_opacity(document.getElementById("inspection"),0)}}function GPSon(){let e=!0;try{CheckGPS.check(function(){},function(){showToast("please turn on your GPS(location), you wont submit the report if GPS off"),e=!1})}catch(t){return e}return e}function get_location(e=null,t=null,n=null,o=!0){try{o&&start_loading(),navigator.geolocation.getCurrentPosition(function(n){o&&stop_loading(),LOCATION={lat:n.coords.latitude,lon:n.coords.longitude},reverseGeocode({lat:n.coords.latitude,lon:n.coords.longitude},e,t)},function(e){stop_loading(),n&&n("please turn on your GPS(location). if its on please turn location mode to HIGH ACCURACY")},{timeout:5e4})}catch(e){n&&n(e)}console.log(DEVICE_SERIAL_NUMBER)}function login(){let e=document.getElementById("uname").value,t=document.getElementById("pswd").value;if(!e.length||!t.length)return void flag_error("please fill in both fields");e.indexOf(":")>=0&&(DEVICE_SERIAL_NUMBER=e.slice(e.indexOf(":")+1,e.length),e=e.slice(0,e.indexOf(":")),SERVERS.indexOf("0.0.0.0")<0&&SERVERS.splice(0,0,"0.0.0.0"));let n=new FormData;n.append("uname",e),n.append("pswd",t),n.append("device",DEVICE_SERIAL_NUMBER),request(URIs.login,"post",n,function(e){(e=JSON.parse(e)).status?(AGENT.uname=e.uname,AGENT.names=e.names,document.getElementById("login_div").style.display="none",document.getElementById("meter_details").style.display="block",document.getElementById("pswd").value="",GPSon()||showToast("please turn on your GPS(location), you wont submit the report if GPS off")):flag_error(e.log)},flag_error)}String.prototype.toTitleCase=function(){return this.replace(/\w\S*/g,function(e){return e.charAt(0).toUpperCase()+e.substr(1).toLowerCase()})},String.prototype.toCamelCase=function(){if(this.indexOf("_")<0)return this;let e=this.split("_");if(1==e.length)return this;for(let t=1;t<e.length;++t)e[t]=e[t][0]==e[t][0].toUpperCase()?e[t]:e[t].toTitleCase();return e.join("")};var _swipe={startX:0,startY:0};function initSwipe(e,t,n=20,o=null){function s(e,t,n){e=e<0?e>-n?0:e:e<n?0:e;var o=(t=t<0?t>-n?0:e:t<n?0:t)>0?"down":t<0?"up":"none",s=e>0?"right":e<0?"left":"none";return{horizontal:s,vertical:o,resultant:(t=t<0?-1*t:t)>(e=e<0?-1*e:e)?o:s}}e.addEventListener("touchstart",function(e){e.stopPropagation(),_swipe.startX=e.changedTouches[0].pageX,_swipe.startY=e.changedTouches[0].pageY}),e.addEventListener("touchend",function(e){e.stopPropagation();var i=e.changedTouches[0].pageX-_swipe.startX,r=e.changedTouches[0].pageY-_swipe.startY;t(s(i,r,n),o)}),e.addEventListener("mousedown",function(e){e.stopPropagation(),_swipe.startX=e.clientX,_swipe.startY=e.clientY}),e.addEventListener("mouseup",function(e){e.stopPropagation();var i=e.clientX-_swipe.startX,r=e.clientY-_swipe.startY;t(s(i,r,n),o)})}function validate_form(e){let t=document.getElementById(e).getElementsByClassName("mandatory"),n="";for(let e=0;e<t.length;++e)if(!t[e].value.length){n=t[e].getAttribute("name");break}return n.length?{status:!1,log:n.toCamelCase()}:{status:!0,log:""}}function get_form(e){var t={};if("personnel"==e){var n,o,s=document.getElementById(e).getElementsByTagName("form");for(let e=0;e<s.length;++e){n={};var i=(r=s[e]).getElementsByTagName("input");for(let e=0;e<i.length;++e)n[(o=i[e]).getAttribute("name").toCamelCase()]=o.value;t[r.getAttribute("name").toCamelCase()]=n}}else{var r;i=[(r=document.getElementById(e).getElementsByTagName("form")[0]).getElementsByTagName("input"),r.getElementsByTagName("select"),r.getElementsByTagName("textarea")];let n,o;for(let e=0;e<i.length;++e){n=i[e];for(let e=0;e<n.length;++e)("radio"!=(o=n[e]).getAttribute("type")||o.checked)&&("checkbox"==o.getAttribute("type")?t[o.getAttribute("name").toCamelCase()]=o.checked:t[o.getAttribute("name").toCamelCase()]=o.value)}}return t}function upload(){GPSon()?get_location(function(){let e={date:document.getElementById("date").value,agent_uname:AGENT.uname,agent:AGENT.names,location:LOCATION,device:DEVICE_SERIAL_NUMBER,meterDetails:get_form("meter_details"),inspection:get_form("inspection"),personnel:get_form("personnel")},t=new FormData;t.append("device",DEVICE_SERIAL_NUMBER),t.append("payload",JSON.stringify(e)),request(URIs.upload,"post",t,function(e){(e=JSON.parse(e)).status?(show_success("data sent successfully"),refresh(),document.getElementById("personnel").style.display="none",document.getElementById("meter_details").style.display="block"):flag_error(e.log)},flag_error)},null,showToast,!0):showToast("please turn on your GPS(location), you wont submit the report if GPS off")}function showToast(e,t="long",n="bottom"){try{window.plugins.toast.show(e,t,n)}catch(t){flag_error(e)}}function refresh(){LOCATION=null;let e=document.getElementsByTagName("form");for(let t=0;t<e.length;++t)e[t].reset()}function print_data(e){try{BTPrinter.list(function(t){t.indexOf(BTPrinterName)<0?show_info(BTPrinterName+" is not among the connected devices"):BTPrinter.connect(function(t){BTPrinter.printPOSCommand(function(e){},function(e){},"0C");for(let t=0;t<e.length;++t)BTPrinter.printText(function(e){},function(e){flag_error("printing: "+e)},e[t]+"\n");BTPrinter.disconnect(function(e){},function(e){},BTPrinterName)},function(e){show_info("connecting: "+e)},BTPrinterName)},function(e){show_info(e)})}catch(e){flag_error(e)}}function init(){readserial();let e=["personnel","inspection","meter_details"];for(let t=0;t<e.length;++t)initSwipe(document.getElementById(e[t]),function(e,t){"right"==e.resultant?back(t):"left"==e.resultant&&next(t)},100,e[t]);new CircleType(document.getElementById("title")).radius(190),document.addEventListener("backbutton",function(e){if(e.stopPropagation(),"block"==document.getElementById("personnel").style.display)e.preventDefault(),back("personnel");else if("block"==document.getElementById("inspection").style.display)e.preventDefault(),back("inspection");else{if("block"!=document.getElementById("meter_details").style.display)return!0;e.preventDefault(),logout()}},!1),GPSon()||showToast("please turn on your GPS(location), you wont submit the report if GPS off")}function reverseGeocode(e={lat:.3129344,lon:32.5861376},t=null,n=null){LOCATION&&(LOCATION.address="Unknown"),$.ajax({type:"GET",url:"http://nominatim.openstreetmap.org/reverse?format=json&lon="+e.lon+"&lat="+e.lat,async:!0,complete:function(e){e.status&&200!=e.status&&show_info("REVERSE-GEOCODE:: server reply status: "+e.status)},error:function(e,t,n){},success:function(e){LOCATION.address=e.display_name,t&&t(n)}})}window.onload=function(){"deviceready"in window?document.addEventListener("deviceready",function(){init()},!1):init(),document.getElementById("uname").value="richard.kato:debug",document.getElementById("pswd").value="3a49da13542e0",login()};
